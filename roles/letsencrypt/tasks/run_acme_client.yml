---
# Ensure fqdn is first in the list of domains to be generated thus garanteeing
# the filename generated by certbot to
# /etc/letsencrypt/live/<fdqn>/fullchain.pem
- name: 'Construct le_domains variable'
  set_fact:
    le_domains: '{{ ([letsencrypt_host] + le_domains) | unique }}'

- name: 'Configure ACME client'
  template:
    src: 'cli.ini.j2'
    dest: '/etc/letsencrypt/{{ letsencrypt_host }}.ini'
    owner: 'root'
    group: 'root'
    mode: '0644'

- name: 'Run certbot'
  command: >-
    certbot certonly
      --config /etc/letsencrypt/{{ letsencrypt_host }}.ini
      --deploy-hook /usr/local/bin/le-deploy-hook.sh
      {%if additional_options is defined %}{{ additional_options }}{% endif %}
  register: res
  changed_when: '"no action taken" not in res.stdout'
