---
# Ensure fqdn is first in the list of domains to be generated thus garanteeing
# the filename generated by certbot to
# /etc/letsencrypt/live/<fdqn>/fullchain.pem
- set_fact:
    le_domains: '{{ ([ansible_host] + le_domains) | unique }}'

- name: 'Configure ACME client'
  template:
    src: 'cli.ini.j2'
    dest: '/etc/letsencrypt/{{ ansible_host }}.ini'
    owner: 'root'
    group: 'root'
    mode: '0644'

- name: 'Run certbot'
  command: >-
    certbot certonly
      --config /etc/letsencrypt/{{ ansible_host }}.ini
      --deploy-hook /usr/local/bin/le-deploy-hook.sh
      {{ additional_options }}
